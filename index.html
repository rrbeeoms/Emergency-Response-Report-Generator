<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勤務回報產生器</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif; background-color: #f0f2f5; display: flex;
            justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box;
        }
        .container {
            background-color: #ffffff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%; max-width: 600px;
        }
        h1 { text-align: center; color: #1c2a5c; margin-bottom: 20px; font-size: 24px; }
        .tab-nav { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 20px; }
        .tab-button {
            padding: 10px 15px; cursor: pointer; border: none; background-color: transparent;
            font-size: 16px; font-weight: 600; color: #495057; position: relative; top: 2px;
        }
        .tab-button.active { color: #007bff; border: 2px solid #dee2e6; border-bottom-color: #fff; border-radius: 5px 5px 0 0; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .form-group { margin-bottom: 20px; position: relative; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        input[type="text"], input[type="number"] {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;
            box-sizing: border-box; font-size: 16px; background-color: #fff;
        }
        .checkbox-group, .radio-group { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .checkbox-group label, .radio-group label { margin-bottom: 0; font-weight: normal; }
        .radio-group { gap: 15px; } /* Spacing for radio buttons */
        .hidden { display: none; }
        
        .options-container {
            display: none; position: absolute; background-color: white; border: 1px solid #ccc;
            border-radius: 5px; max-height: 200px; overflow-y: auto; width: 100%; z-index: 1000;
        }
        .option-item { padding: 10px; cursor: pointer; }
        .option-item:hover { background-color: #f0f0f0; }
        .time-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .time-group .input-wrapper { flex: 1; min-width: 60px; position: relative; margin-bottom: 5px; }
        .time-group .unit { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #888; pointer-events: none; }
        .time-group input { padding-right: 30px; }
        
        button {
            width: 100%; padding: 12px; font-size: 16px; font-weight: bold; color: #fff; background-color: #007bff;
            border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; margin-top: 10px;
        }
        button:hover { background-color: #0056b3; }
        .copy-btn { background-color: #28a745; }
        .copy-btn:hover { background-color: #218838; }
        
        #result, #handoverResult {
            margin-top: 25px; padding: 15px; background-color: #e9ecef; border: 1px solid #ced4da;
            border-radius: 5px; min-height: 100px; line-height: 1.8; color: #495057; white-space: pre-wrap; word-wrap: break-word;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>勤務回報產生器</h1>

        <div class="tab-nav">
            <button class="tab-button active" data-tab="emergencyReport">緊急回報</button>
            <button class="tab-button" data-tab="handoverReport">接班回報</button>
        </div>

        <div id="emergencyReport" class="tab-pane active">
            <!-- 緊急回報 HTML 內容 -->
        </div>

        <div id="handoverReport" class="tab-pane">
            <!-- MODIFICATION: Added Shift Mode Choice -->
            <div class="form-group">
                <label>回報模式</label>
                <div class="radio-group">
                    <label><input type="radio" name="shiftMode" id="shiftModeNext" value="next" checked> 預測下個班別 (預設)</label>
                    <label><input type="radio" name="shiftMode" id="shiftModePrevious" value="previous"> 回報當前/上個班別</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="currentOfficerInput">接班人</label>
                <input type="text" id="currentOfficerInput" class="searchable-input" placeholder="點此選取或輸入關鍵字搜尋...">
                <div class="options-container" id="currentOfficerOptions"></div>
                <div class="checkbox-group">
                    <input type="checkbox" id="isSubstitute" style="width: auto;">
                    <label for="isSubstitute">此為代理值班</label>
                </div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="supervisorPresent" style="width: auto;">
                    <label for="supervisorPresent">值勤主管有進駐</label>
                </div>
                <div id="supervisorGroup" class="form-group hidden" style="margin-top:10px; margin-bottom:0;">
                    <label for="supervisorInput">值勤主管</label>
                    <input type="text" id="supervisorInput" class="searchable-input" placeholder="點此選取或輸入關鍵字搜尋...">
                    <div class="options-container" id="supervisorOptions"></div>
                </div>
            </div>

            <div class="form-group">
                <label>後二班輪值人員 (自動帶入)</label>
                <div class="form-group" style="margin-bottom: 5px;">
                    <input type="text" id="nextOfficer1Input" class="searchable-input" placeholder="第一位">
                    <div class="options-container" id="nextOfficer1Options"></div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <input type="text" id="nextOfficer2Input" class="searchable-input" placeholder="第二位">
                    <div class="options-container" id="nextOfficer2Options"></div>
                </div>
            </div>

            <div id="handoverResult"></div>
            <button id="copyHandoverBtn" class="copy-btn">複製訊息</button>
        </div>
    </div>

    <script>
        // --- Lists of Personnel ---
        const supervisors = ["李科長大川", "陳主任巧穎", "林科長秀香", "李科長育欣", "張主任廣量", "陳主任建霖", "藍科長苑綾", "黃科長景明", "魏主任慶政"];
        const shiftOfficers = ["吳文鴻", "張焜歆", "楊麗雯", "洪維達", "郭建志", "陳鑫源", "蕭志憲", "楊宗達", "林俊宏", "劉育銘", "戴振達", "林文濤", "陳金保", "林太祈", "柳旻佐", "林志明", "吳宏仁", "張愷文", "林昶宏", "胡元昌"];

        // --- localStorage Keys ---
        const EVENT_NAME_KEY = 'savedEventName', EMERGENCY_PERSON_KEY = 'savedEmergencyPersonName',
              HANDOVER_CURRENT_OFFICER_KEY = 'savedCurrentOfficer', HANDOVER_SUBSTITUTE_KEY = 'savedIsSubstitute',
              HANDOVER_SUPERVISOR_PRESENT_KEY = 'savedSupervisorPresent', HANDOVER_SUPERVISOR_KEY = 'savedSupervisor',
              HANDOVER_SHIFT_MODE_KEY = 'savedShiftMode'; // New key for saving mode
              
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Selection (Lazy selection within listener) ---
            const emergencyPane = document.getElementById('emergencyReport');
            emergencyPane.innerHTML = `
                <div class="form-group"><label for="eventName">事件名稱</label><input type="text" id="eventName"></div>
                <div class="form-group"><label>回報日期與時間</label><div class="time-group">
                    <div class="input-wrapper"><input type="number" id="rocYear"><span class="unit">年</span></div><div class="input-wrapper"><input type="number" id="month"><span class="unit">月</span></div>
                    <div class="input-wrapper"><input type="number" id="day"><span class="unit">日</span></div><div class="input-wrapper"><input type="number" id="hour" min="0" max="23"><span class="unit">時</span></div>
                    <div class="input-wrapper"><input type="number" id="minute" min="0" max="59"><span class="unit">分</span></div></div></div>
                <div class="form-group"><label for="personName">鐵道局值班人員</label><input type="text" id="personName"></div>
                <button id="generateBtn">產生回報內容</button><div id="result"></div><button id="copyBtn" class="copy-btn">複製內容</button>
            `;
            const emergencyElements = {
                eventNameInput: document.getElementById('eventName'), personNameInput: document.getElementById('personName'), resultDiv: document.getElementById('result'),
                generateBtn: document.getElementById('generateBtn'), copyBtn: document.getElementById('copyBtn'),
                rocYearInput: document.getElementById('rocYear'), monthInput: document.getElementById('month'), dayInput: document.getElementById('day'),
                hourInput: document.getElementById('hour'), minuteInput: document.getElementById('minute')
            };

            const handoverElements = {
                resultDiv: document.getElementById('handoverResult'), copyBtn: document.getElementById('copyHandoverBtn'),
                isSubstituteInput: document.getElementById('isSubstitute'), supervisorPresent: document.getElementById('supervisorPresent'),
                supervisorGroup: document.getElementById('supervisorGroup'), shiftModeRadios: document.querySelectorAll('input[name="shiftMode"]')
            };

            const searchableInputs = {
                currentOfficer: { input: document.getElementById('currentOfficerInput'), options: document.getElementById('currentOfficerOptions'), data: shiftOfficers },
                supervisor: { input: document.getElementById('supervisorInput'), options: document.getElementById('supervisorOptions'), data: supervisors },
                nextOfficer1: { input: document.getElementById('nextOfficer1Input'), options: document.getElementById('nextOfficer1Options'), data: shiftOfficers },
                nextOfficer2: { input: document.getElementById('nextOfficer2Input'), options: document.getElementById('nextOfficer2Options'), data: shiftOfficers }
            };

            const tabButtons = document.querySelectorAll('.tab-button'), tabPanes = document.querySelectorAll('.tab-pane');
            const weekMap = ['日', '一', '二', '三', '四', '五', '六'];

            // --- Main Functions ---
            function updateNextOfficers(selectedOfficerName) {
                const currentIndex = shiftOfficers.indexOf(selectedOfficerName);
                if (currentIndex === -1) return;
                const nextIndex1 = (currentIndex + 1) % shiftOfficers.length;
                const nextIndex2 = (currentIndex + 2) % shiftOfficers.length;
                searchableInputs.nextOfficer1.input.value = shiftOfficers[nextIndex1];
                searchableInputs.nextOfficer2.input.value = shiftOfficers[nextIndex2];
            }

            function initSearchableSelect(config) {
                config.input.addEventListener('keyup', () => {
                    const searchTerm = config.input.value.toLowerCase();
                    const filteredData = config.data.filter(item => item.toLowerCase().includes(searchTerm));
                    config.options.innerHTML = '';
                    filteredData.forEach(item => {
                        const optionEl = document.createElement('div');
                        optionEl.classList.add('option-item');
                        optionEl.textContent = item;
                        optionEl.addEventListener('click', () => {
                            config.input.value = item;
                            config.options.style.display = 'none';
                            if (config === searchableInputs.currentOfficer) {
                                updateNextOfficers(item);
                            }
                            generateHandoverReport();
                        });
                        config.options.appendChild(optionEl);
                    });
                    config.options.style.display = filteredData.length > 0 ? 'block' : 'none';
                });
                config.input.addEventListener('focus', () => config.input.dispatchEvent(new Event('keyup')));
            }
            
            function generateHandoverReport() {
                const mode = document.querySelector('input[name="shiftMode"]:checked').value;
                const now = new Date();
                const currentHour = now.getHours();
                let startTime = new Date(now), endTime = new Date(now);

                if (mode === 'next') {
                    // --- Logic to predict the NEXT shift ---
                    if (currentHour >= 20) { // After 8 PM, next shift is tomorrow morning
                        startTime.setDate(now.getDate() + 1); startTime.setHours(8, 0, 0, 0);
                        endTime.setDate(now.getDate() + 1); endTime.setHours(20, 0, 0, 0);
                    } else if (currentHour >= 8) { // Between 8 AM and 8 PM, next shift is tonight
                        startTime.setHours(20, 0, 0, 0);
                        endTime.setDate(now.getDate() + 1); endTime.setHours(8, 0, 0, 0);
                    } else { // Before 8 AM, next shift is this morning
                        startTime.setHours(8, 0, 0, 0);
                        endTime.setHours(20, 0, 0, 0);
                    }
                } else { // mode === 'previous'
                    // --- Logic to find the CURRENT or LAST shift ---
                    if (currentHour >= 8 && currentHour < 20) { // Currently in day shift
                        startTime.setHours(8, 0, 0, 0);
                        endTime.setHours(20, 0, 0, 0);
                    } else { // Currently in night shift
                        if (currentHour >= 20) { // Early part of night shift
                            startTime.setHours(20, 0, 0, 0);
                            endTime.setDate(now.getDate() + 1); endTime.setHours(8, 0, 0, 0);
                        } else { // Late part of night shift (after midnight)
                            startTime.setDate(now.getDate() - 1); startTime.setHours(20, 0, 0, 0);
                            endTime.setHours(8, 0, 0, 0);
                        }
                    }
                }

                const startTimeStr = startTime.getHours() === 8 ? "08:00" : "20:00";
                const endTimeStr = endTime.getHours() === 8 ? "08:00" : "20:00";

                const formatShiftDate = (date) => `${date.getMonth() + 1}/${date.getDate()}（${weekMap[date.getDay()]}）`;
                const dateLine = `${formatShiftDate(startTime)} ${startTimeStr}-${formatShiftDate(endTime)} ${endTimeStr}`;
                const officerLine = `接班人：${searchableInputs.currentOfficer.input.value}${handoverElements.isSubstituteInput.checked ? '(代值)' : ''}。`;
                let supervisorLine = "";
                if (handoverElements.supervisorPresent.checked) {
                    supervisorLine = `\n執勤主管：${searchableInputs.supervisor.input.value}`;
                }
                const nextOfficersLine = `\n後二班依序由${searchableInputs.nextOfficer1.input.value}、${searchableInputs.nextOfficer2.input.value}輪值。`;
                handoverElements.resultDiv.textContent = dateLine + "\n" + officerLine + supervisorLine + nextOfficersLine;
                
                // Save state
                localStorage.setItem(HANDOVER_SHIFT_MODE_KEY, mode);
                localStorage.setItem(HANDOVER_CURRENT_OFFICER_KEY, searchableInputs.currentOfficer.input.value);
                localStorage.setItem(HANDOVER_SUBSTITUTE_KEY, handoverElements.isSubstituteInput.checked);
                localStorage.setItem(HANDOVER_SUPERVISOR_PRESENT_KEY, handoverElements.supervisorPresent.checked);
                localStorage.setItem(HANDOVER_SUPERVISOR_KEY, searchableInputs.supervisor.input.value);
            }

            // --- Initialization ---
            for (const key in searchableInputs) { initSearchableSelect(searchableInputs[key]); }

            const loadSavedValue = (key, dataArray, defaultValue) => {
                const savedValue = localStorage.getItem(key);
                return (savedValue && dataArray.includes(savedValue)) ? savedValue : defaultValue;
            };

            const savedMode = localStorage.getItem(HANDOVER_SHIFT_MODE_KEY);
            if (savedMode === 'previous') {
                document.getElementById('shiftModePrevious').checked = true;
            } else {
                document.getElementById('shiftModeNext').checked = true;
            }

            const savedCurrentOfficer = loadSavedValue(HANDOVER_CURRENT_OFFICER_KEY, shiftOfficers, shiftOfficers[0]);
            searchableInputs.currentOfficer.input.value = savedCurrentOfficer;
            updateNextOfficers(savedCurrentOfficer);
            searchableInputs.supervisor.input.value = loadSavedValue(HANDOVER_SUPERVISOR_KEY, supervisors, supervisors[0]);
            handoverElements.isSubstituteInput.checked = (localStorage.getItem(HANDOVER_SUBSTITUTE_KEY) === 'true');
            handoverElements.supervisorPresent.checked = (localStorage.getItem(HANDOVER_SUPERVISOR_PRESENT_KEY) === 'true');
            if (handoverElements.supervisorPresent.checked) { handoverElements.supervisorGroup.classList.remove('hidden'); }
            
            emergencyElements.eventNameInput.value = localStorage.getItem(EVENT_NAME_KEY) || "0728豪雨";
            emergencyElements.personNameInput.value = localStorage.getItem(EMERGENCY_PERSON_KEY) || "鄒承諺";
            const now = new Date();
            emergencyElements.rocYearInput.value = now.getFullYear() - 1911;
            emergencyElements.monthInput.value = now.getMonth() + 1;
            emergencyElements.dayInput.value = now.getDate();
            emergencyElements.hourInput.value = now.getHours();
            emergencyElements.minuteInput.value = now.getMinutes();
            
            generateHandoverReport();

            // --- Event Listeners ---
            emergencyElements.generateBtn.addEventListener('click', () => {
                localStorage.setItem(EVENT_NAME_KEY, emergencyElements.eventNameInput.value);
                localStorage.setItem(EMERGENCY_PERSON_KEY, emergencyElements.personNameInput.value);
                const { eventNameInput, rocYearInput, monthInput, dayInput, hourInput, minuteInput, personNameInput, resultDiv } = emergencyElements;
                resultDiv.textContent = `${eventNameInput.value}緊急應變小組${rocYearInput.value}年${monthInput.value}月${dayInput.value}日${hourInput.value}時${minuteInput.value}分回報鐵道局值勤人員（${personNameInput.value}）本分局工區一切正常`;
            });
            emergencyElements.copyBtn.addEventListener('click', () => copyToClipboard('result'));
            handoverElements.copyBtn.addEventListener('click', () => copyToClipboard('handoverResult'));
            
            handoverElements.supervisorPresent.addEventListener('change', () => {
                handoverElements.supervisorGroup.classList.toggle('hidden', !handoverElements.supervisorPresent.checked);
                generateHandoverReport();
});
            handoverElements.isSubstituteInput.addEventListener('change', generateHandoverReport);
            handoverElements.shiftModeRadios.forEach(radio => radio.addEventListener('change', generateHandoverReport));
            
            Object.values(searchableInputs).forEach(config => {
                 if (config.input !== searchableInputs.currentOfficer.input) {
                    config.input.addEventListener('change', generateHandoverReport);
                }
            });

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                });
            });

            document.addEventListener('click', (e) => {
                for (const key in searchableInputs) {
                    if (!searchableInputs[key].input.contains(e.target) && !searchableInputs[key].options.contains(e.target)) {
                        searchableInputs[key].options.style.display = 'none';
                    }
                }
            });
        });

        function copyToClipboard(elementId) {
            const textToCopy = document.getElementById(elementId).textContent;
            const buttonId = (elementId === 'result') ? 'copyBtn' : 'copyHandoverBtn';
            const buttonElement = document.getElementById(buttonId);
            if (!textToCopy) { alert('沒有內容可以複製！'); return; }
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '已複製！';
                const newText = (buttonId === 'copyBtn') ? "複製內容" : "複製訊息";
                setTimeout(() => { buttonElement.textContent = newText; }, 2000);
            });
        }
    </script>
</body>
</html>
